// Teams Data
const teamsData = [
    {
        id: 1,
        name: 'Mbarara',
        logo: 'mbarara.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Afande',
        position: 1,
        played: 28,
        won: 20,
        drawn: 4,
        lost: 4,
        points: 64,
        squad: [
            { number: 1, name: 'Afande', position: 'Forward' },
            { number: 2, name: 'Success', position: 'Midfielder' },
            { number: 3, name: 'Amon', position: 'Defender' },
            { number: 4, name: 'Benard', position: 'Midfielder' },
            { number: 5, name: 'Cliff', position: 'Defender' },
            { number: 6, name: 'Keneth Maiso', position: 'Midfielder' },
            { number: 7, name: 'Tony', position: 'Forward' },
            { number: 8, name: 'Kabagambe', position: 'Midfielder' },
            { number: 9, name: 'Davie', position: 'Forward' },
            { number: 10, name: 'Elaisha', position: 'Midfielder' },
            { number: 11, name: 'Gitta', position: 'Forward' },
            { number: 12, name: 'Martin', position: 'Defender' },
            { number: 13, name: 'Latif', position: 'Midfielder' },
            { number: 14, name: 'Muzoora', position: 'Defender' },
            { number: 15, name: 'Malcom', position: 'Midfielder' },
            { number: 16, name: 'Jude', position: 'Forward' },
            { number: 17, name: 'Ballack', position: 'Midfielder' },
            { number: 18, name: 'Ronny', position: 'Defender' }
        ]
    },
    {
        id: 2,
        name: 'Wakiso',
        logo: 'wakiso.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Matayo',
        position: 2,
        played: 28,
        won: 18,
        drawn: 6,
        lost: 4,
        points: 60,
        squad: [
            { number: 1, name: 'Matayo', position: 'Forward' },
            { number: 2, name: 'Herbert I', position: 'Midfielder' },
            { number: 3, name: 'Uncle Mo', position: 'Defender' },
            { number: 4, name: 'Chance', position: 'Midfielder' },
            { number: 5, name: 'Rodney', position: 'Defender' },
            { number: 7, name: 'Gideon K', position: 'Midfielder' },
            { number: 8, name: 'Edgar Arinetwe', position: 'Midfielder' },
            { number: 9, name: 'Tugume M', position: 'Forward' },
            { number: 10, name: 'Kevin Barbs', position: 'Forward' },
            { number: 11, name: 'Mose Kayima', position: 'Midfielder' },
            { number: 12, name: 'Wasswa', position: 'Defender' },
            { number: 13, name: 'Ivan M', position: 'Midfielder' },
            { number: 14, name: 'William', position: 'Defender' },
            { number: 15, name: 'Emran', position: 'Midfielder' },
            { number: 16, name: 'Amuriat', position: 'Forward' },
            { number: 17, name: 'Denis H', position: 'Midfielder' },
            { number: 18, name: 'Sancho', position: 'Forward' }
        ]
    },
    {
        id: 3,
        name: 'Arua',
        logo: 'arua.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Aaron',
        position: 3,
        played: 28,
        won: 16,
        drawn: 7,
        lost: 5,
        points: 55,
        squad: [
            { number: 1, name: 'Aaron', position: 'Defender' },
            { number: 2, name: 'Sharif', position: 'Midfielder' },
            { number: 3, name: 'Denis', position: 'Forward' },
            { number: 4, name: 'Emmy', position: 'Midfielder' },
            { number: 5, name: 'Millio', position: 'Defender' },
            { number: 6, name: 'Franco', position: 'Midfielder' },
            { number: 7, name: 'Mykolo', position: 'Defender' },
            { number: 8, name: 'Emo', position: 'Midfielder' },
            { number: 9, name: 'Aggrey', position: 'Forward' },
            { number: 10, name: 'Arthur O', position: 'Midfielder' },
            { number: 11, name: 'Mark O', position: 'Forward' },
            { number: 12, name: 'Victor', position: 'Defender' },
            { number: 13, name: 'Melody', position: 'Midfielder' },
            { number: 14, name: 'Asaph', position: 'Defender' },
            { number: 15, name: 'Falcon', position: 'Midfielder' },
            { number: 16, name: 'Henry', position: 'Forward' },
            { number: 17, name: 'Felix', position: 'Midfielder' },
            { number: 18, name: 'Alex Ifeanyi', position: 'Defender' },
            { number: 19, name: 'Mike', position: 'Forward' }
        ]
    },
    {
        id: 4,
        name: 'Kabale',
        logo: 'kabale.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Jemmy',
        position: 4,
        played: 28,
        won: 15,
        drawn: 8,
        lost: 5,
        points: 53,
        squad: [
            { number: 1, name: 'Jemmy', position: 'Forward' },
            { number: 2, name: 'Isaac M', position: 'Midfielder' },
            { number: 3, name: 'Aziz', position: 'Defender' },
            { number: 4, name: 'Chairman', position: 'Midfielder' },
            { number: 5, name: 'Fafa', position: 'Defender' },
            { number: 6, name: 'Stephen', position: 'Midfielder' },
            { number: 7, name: 'David', position: 'Forward' },
            { number: 8, name: 'Josh Muzaaya', position: 'Midfielder' },
            { number: 9, name: 'Brian H', position: 'Forward' },
            { number: 10, name: 'Russel', position: 'Midfielder' },
            { number: 11, name: 'Myles', position: 'Forward' },
            { number: 12, name: 'Timo M', position: 'Defender' },
            { number: 13, name: 'Kibalama', position: 'Midfielder' },
            { number: 14, name: 'Stuart', position: 'Defender' },
            { number: 15, name: 'Kabox', position: 'Midfielder' },
            { number: 16, name: 'Marvin B', position: 'Forward' },
            { number: 17, name: 'Justus', position: 'Midfielder' },
            { number: 18, name: 'Duglus', position: 'Defender' }
        ]
    },
    {
        id: 5,
        name: 'Mbale',
        logo: 'mbale.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Dejango',
        position: 5,
        played: 28,
        won: 14,
        drawn: 7,
        lost: 7,
        points: 49,
        squad: [
            { number: 1, name: 'Dejango', position: 'Forward' },
            { number: 2, name: 'Benja', position: 'Midfielder' },
            { number: 3, name: 'Allan G', position: 'Defender' },
            { number: 4, name: 'Peter K', position: 'Midfielder' },
            { number: 5, name: 'Demba', position: 'Defender' },
            { number: 6, name: 'Ambrose', position: 'Midfielder' },
            { number: 7, name: 'Marvin Dadiyo', position: 'Forward' },
            { number: 8, name: 'Ephraim', position: 'Midfielder' },
            { number: 9, name: 'Bobby', position: 'Forward' },
            { number: 10, name: 'Eric', position: 'Midfielder' },
            { number: 11, name: 'Ivan', position: 'Forward' },
            { number: 12, name: 'Drogba', position: 'Forward' },
            { number: 13, name: 'Dembe', position: 'Defender' },
            { number: 14, name: 'Bruno Sali', position: 'Midfielder' },
            { number: 15, name: 'Shafiq', position: 'Defender' },
            { number: 16, name: 'Abbey', position: 'Midfielder' },
            { number: 17, name: 'Isaac', position: 'Forward' },
            { number: 18, name: 'Guvnor Drake', position: 'Defender' }
        ]
    },
    {
        id: 6,
        name: 'Masaka',
        logo: 'masaka.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Kagame',
        position: 6,
        played: 28,
        won: 13,
        drawn: 8,
        lost: 7,
        points: 47,
        squad: [
            { number: 1, name: 'Kagame', position: 'Forward' },
            { number: 2, name: 'Ken', position: 'Midfielder' },
            { number: 3, name: 'Barney', position: 'Defender' },
            { number: 4, name: 'Pato', position: 'Midfielder' },
            { number: 5, name: 'Coach Musisi', position: 'Defender' },
            { number: 6, name: 'Messi', position: 'Midfielder' },
            { number: 7, name: 'Bob', position: 'Forward' },
            { number: 8, name: 'Shakes', position: 'Midfielder' },
            { number: 9, name: 'Sir Aludah', position: 'Forward' },
            { number: 10, name: 'Fem DJ', position: 'Midfielder' },
            { number: 11, name: 'Ivan DJ', position: 'Forward' },
            { number: 12, name: 'Shizzo', position: 'Defender' },
            { number: 13, name: 'Brian DJ', position: 'Midfielder' },
            { number: 14, name: 'Rex K', position: 'Defender' },
            { number: 15, name: 'Felix SR', position: 'Midfielder' },
            { number: 16, name: 'Kagame', position: 'Forward' },
            { number: 17, name: 'Shabby', position: 'Midfielder' },
            { number: 18, name: 'Kelvin', position: 'Defender' }
        ]
    },
    {
        id: 7,
        name: 'Jinja',
        logo: 'jinja.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Javan',
        position: 7,
        played: 28,
        won: 12,
        drawn: 8,
        lost: 8,
        points: 44,
        squad: [
            { number: 1, name: 'Javan', position: 'Forward' },
            { number: 2, name: 'BK', position: 'Midfielder' },
            { number: 3, name: 'Striker', position: 'Forward' },
            { number: 4, name: 'Osbie', position: 'Midfielder' },
            { number: 5, name: 'Dario', position: 'Defender' },
            { number: 6, name: 'Douglas', position: 'Midfielder' },
            { number: 7, name: 'Dero', position: 'Forward' },
            { number: 8, name: 'Timo K', position: 'Midfielder' },
            { number: 9, name: 'Charlie', position: 'Forward' },
            { number: 10, name: 'Bryo', position: 'Midfielder' },
            { number: 11, name: 'Patrick', position: 'Forward' },
            { number: 12, name: 'Kaisha', position: 'Defender' },
            { number: 13, name: 'Brim', position: 'Midfielder' },
            { number: 14, name: 'Pius', position: 'Defender' },
            { number: 15, name: 'Gero', position: 'Midfielder' },
            { number: 16, name: 'Eria', position: 'Forward' },
            { number: 17, name: 'Brian Wesonga', position: 'Midfielder' },
            { number: 18, name: 'Vasher', position: 'Defender' },
            { number: 19, name: 'Animal', position: 'Forward' }
        ]
    },
    {
        id: 8,
        name: 'Gulu',
        logo: 'gulu.svg',
        founded: 2024,
        stadium: 'Maracanã Stadium',
        manager: 'Solomon O',
        position: 8,
        played: 28,
        won: 11,
        drawn: 8,
        lost: 9,
        points: 41,
        squad: [
            { number: 1, name: 'Solomon O', position: 'Forward' },
            { number: 2, name: 'Sebastien', position: 'Midfielder' },
            { number: 3, name: 'Allano', position: 'Defender' },
            { number: 4, name: 'Panda', position: 'Midfielder' },
            { number: 5, name: 'Walash', position: 'Defender' },
            { number: 6, name: 'Jaguar', position: 'Midfielder' },
            { number: 7, name: 'Trevor', position: 'Forward' },
            { number: 8, name: 'Musaazi A', position: 'Midfielder' },
            { number: 9, name: 'Charles', position: 'Forward' },
            { number: 10, name: 'Marc Henry', position: 'Midfielder' },
            { number: 11, name: 'Kityo', position: 'Forward' },
            { number: 12, name: 'Jose', position: 'Defender' },
            { number: 13, name: 'Robert', position: 'Midfielder' },
            { number: 14, name: 'Edgar M', position: 'Defender' },
            { number: 15, name: 'JK', position: 'Midfielder' },
            { number: 16, name: 'Brian', position: 'Forward' },
            { number: 17, name: 'Wilson', position: 'Midfielder' },
            { number: 18, name: 'Alex Katongole', position: 'Defender' }
        ]
    }
];

// DOM Elements
const teamsGrid = document.querySelector('.teams-grid');
const searchInput = document.querySelector('.teams-search input');
const filterButtons = document.querySelectorAll('.filter-btn');
const teamModal = document.querySelector('.team-modal');
const modalContent = document.querySelector('.modal-content');
const modalClose = document.querySelector('.modal-close');
const loadingSpinner = document.querySelector('.loading-spinner');

// Add debug logging
console.log('Teams.js loaded');
console.log('teamsGrid element:', teamsGrid);
console.log('Teams data:', teamsData);

// State
let currentFilter = 'all';
let searchQuery = '';

// Functions
function calculateTeamStats() {
    const teamStats = {};

    // Initialize stats for all teams
    teamsData.forEach(team => {
        teamStats[team.name] = {
            id: team.id,
            name: team.name,
            logo: team.logo,
            stadium: team.stadium,
            squad: team.squad,
            founded: team.founded,
            manager: team.manager,
            played: team.played || 0,
            wins: team.won || 0,
            draws: team.drawn || 0,
            losses: team.lost || 0,
            goalsFor: 0,
            goalsAgainst: 0,
            goalDifference: 0,
            points: team.points || 0,
            form: [],
            position: team.position || 0
        };
    });

    // Process matches from fixturesData if available
    if (typeof window.fixturesData !== 'undefined' && Array.isArray(window.fixturesData)) {
        // Reset stats before processing matches
        Object.values(teamStats).forEach(team => {
            team.played = 0;
            team.wins = 0;
            team.draws = 0;
            team.losses = 0;
            team.points = 0;
            team.goalsFor = 0;
            team.goalsAgainst = 0;
            team.form = [];
        });

        window.fixturesData.forEach(timeSlot => {
            timeSlot.matches.forEach(match => {
                if (match.status === 'completed') {
                    const homeStats = teamStats[match.homeTeam];
                    const awayStats = teamStats[match.awayTeam];

                    if (homeStats && awayStats) {
                        // Update match played count
                        homeStats.played++;
                        awayStats.played++;

                        // Update goals
                        homeStats.goalsFor += match.homeScore;
                        homeStats.goalsAgainst += match.awayScore;
                        awayStats.goalsFor += match.awayScore;
                        awayStats.goalsAgainst += match.homeScore;

                        // Update results and points
                        if (match.homeScore > match.awayScore) {
                            homeStats.wins++;
                            homeStats.points += 3;
                            homeStats.form.push('W');
                            awayStats.losses++;
                            awayStats.form.push('L');
                        } else if (match.homeScore < match.awayScore) {
                            awayStats.wins++;
                            awayStats.points += 3;
                            awayStats.form.push('W');
                            homeStats.losses++;
                            homeStats.form.push('L');
                        } else {
                            homeStats.draws++;
                            awayStats.draws++;
                            homeStats.points++;
                            awayStats.points++;
                            homeStats.form.push('D');
                            awayStats.form.push('D');
                        }
                    }
                }
            });
        });

        // Calculate goal differences and limit form to last 5 matches
        Object.values(teamStats).forEach(team => {
            team.goalDifference = team.goalsFor - team.goalsAgainst;
            team.form = team.form.slice(-5);
        });
    }

    // Convert to array and sort
    const teams = Object.values(teamStats);
    
    // Sort teams by points, goal difference, goals scored, and name
    teams.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.goalDifference !== a.goalDifference) return b.goalDifference - a.goalDifference;
        if (b.goalsFor !== a.goalsFor) return b.goalsFor - a.goalsFor;
        return a.name.localeCompare(b.name);
    });

    // Update positions
    teams.forEach((team, index) => {
        team.position = index + 1;
    });

    return teams;
}

function createFormIndicators(form) {
    return form.map(result => {
        const className = result === 'W' ? 'form-win' : result === 'D' ? 'form-draw' : 'form-loss';
        return `<div class="form-indicator ${className}">${result}</div>`;
    }).join('');
}

function displayTeams(filter = 'all') {
    const teamsGrid = document.querySelector('.teams-grid');
    const teams = calculateTeamStats();
    const searchQuery = document.querySelector('.teams-search input')?.value.toLowerCase() || '';
    
    let filteredTeams = teams;
    
    // Apply search filter first
    if (searchQuery) {
        filteredTeams = teams.filter(team => 
            team.name.toLowerCase().includes(searchQuery) ||
            team.manager.toLowerCase().includes(searchQuery) ||
            team.stadium.toLowerCase().includes(searchQuery) ||
            team.squad.some(player => player.name.toLowerCase().includes(searchQuery))
        );
    }
    
    // Then apply position filter
    switch(filter) {
        case 'top':
            filteredTeams = filteredTeams.filter(team => team.position <= 4);
            break;
        case 'middle':
            filteredTeams = filteredTeams.filter(team => team.position > 4 && team.position <= 6);
            break;
        case 'bottom':
            filteredTeams = filteredTeams.filter(team => team.position > 6);
            break;
    }

    if (!filteredTeams.length) {
        teamsGrid.innerHTML = '<div class="no-results">No teams found</div>';
        return;
    }

    teamsGrid.innerHTML = filteredTeams.map(team => `
        <div class="team-card ${team.position <= 4 ? 'qualification' : 'non-qualification'}" data-team-id="${team.id}">
            <div class="team-banner"></div>
            <div class="team-logo">
                <img src="images/club-logos/${team.logo}" alt="${team.name} logo">
            </div>
            <div class="team-info">
                <h3 class="team-name">${team.name}</h3>
                <p class="team-captain">${team.manager} 👔</p>
                <p class="team-stadium">${team.stadium}</p>
                <div class="team-details">
                    <div class="detail-item">
                        <div class="detail-label">Position</div>
                        <div class="detail-value">${team.position}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Points</div>
                        <div class="detail-value">${team.points}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Form</div>
                        <div class="detail-value form-indicators">${createFormIndicators(team.form)}</div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');

    // Add fade-in animation to cards
    const cards = document.querySelectorAll('.team-card');
    cards.forEach((card, index) => {
        card.style.animation = `fadeIn 0.5s ease forwards ${index * 0.1}s`;
    });
}

function showTeamDetails(teamId) {
    const teams = calculateTeamStats();
    const team = teams.find(t => t.id === parseInt(teamId));
    if (!team) return;

    const modalContent = document.querySelector('.modal-content');
    modalContent.innerHTML = `
        <div class="modal-header">
            <div class="modal-logo">
                <img src="images/club-logos/${team.logo}" alt="${team.name} logo">
            </div>
            <div class="modal-team-info">
                <h2>${team.name}</h2>
                <p>Founded: ${team.founded}</p>
                <p>Manager: ${team.manager}</p>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="team-stats">
                <div class="stat-card">
                    <div class="stat-value">${team.position}</div>
                    <div class="stat-label">Position</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${team.points}</div>
                    <div class="stat-label">Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${team.wins}</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${team.draws}</div>
                    <div class="stat-label">Draws</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${team.losses}</div>
                    <div class="stat-label">Losses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${team.goalDifference > 0 ? '+' + team.goalDifference : team.goalDifference}</div>
                    <div class="stat-label">Goal Difference</div>
                </div>
            </div>
            <div class="form-section">
                <h3>Recent Form</h3>
                <div class="form-indicators">
                    ${createFormIndicators(team.form)}
                </div>
            </div>
            <div class="squad-section">
                <h3>Squad</h3>
                <div class="squad-grid">
                    ${team.squad.map((player, index) => `
                        <div class="player-card">
                            <div class="player-number">${player.number}</div>
                            <div class="player-info">
                                <h4>${player.name} ${index === 0 ? '©️' : ''}</h4>
                                <div class="player-position">${player.position}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;

    const modal = document.querySelector('.team-modal');
    modal.style.display = 'flex';
    setTimeout(() => modalContent.classList.add('slide-in'), 10);
}

function closeModal() {
    modalContent.classList.remove('slide-in');
    teamModal.style.display = 'none';
}

function showLoading() {
    loadingSpinner.style.display = 'block';
    teamsGrid.style.opacity = '0.5';
}

function hideLoading() {
    loadingSpinner.style.display = 'none';
    teamsGrid.style.opacity = '1';
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    // Initialize teams display
    displayTeams();

    // Search functionality with debounce
    const searchInput = document.querySelector('.teams-search input');
    let searchTimeout;

    if (searchInput) {
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
                displayTeams(activeFilter);
            }, 300);
        });
    }

    // Filter buttons
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            displayTeams(button.dataset.filter);
        });
    });

    // Add click event listener for team cards
    const teamsGrid = document.querySelector('.teams-grid');
    teamsGrid.addEventListener('click', (e) => {
        const teamCard = e.target.closest('.team-card');
        if (teamCard) {
            const teamId = teamCard.dataset.teamId;
            showTeamDetails(teamId);
        }
    });

    // Add click event listener for modal close
    const teamModal = document.querySelector('.team-modal');
    const modalContent = document.querySelector('.modal-content');
    
    teamModal.addEventListener('click', (e) => {
        if (e.target === teamModal) {
            closeModal();
        }
    });
});

// Add keyboard navigation for modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && teamModal.style.display === 'flex') {
        closeModal();
    }
});

// Event Listeners
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-close')) {
        closeModal();
    }
});

// Set 'All Teams' button as active by default
const allTeamsButton = document.querySelector('.filter-btn[data-filter="all"]');
if (allTeamsButton) {
    console.log('Setting All Teams button as active');
    allTeamsButton.classList.add('active');
} 